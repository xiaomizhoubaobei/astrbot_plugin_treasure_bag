name: 'Release æ„å»º'

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘æˆ–æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches:
      - main
    paths:
      - '**/*.py'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: read

jobs:
  build:
    name: æ„å»º Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write  # ä¸ºç­¾åæ‰€å¿…éœ€

    steps:
      # 0. å®‰å…¨åŠ å›º
      - name: åŠ å›ºè¿è¡Œå™¨
        uses: step-security/harden-runner@c6295a65d1254861815972266d5933fd6e532bdf # v2.11.1
        with:
          egress-policy: audit

      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„ git å†å²

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: '3.12'

      # 3. è·å–ç‰ˆæœ¬å·
      - name: è·å–ç‰ˆæœ¬
        id: get_version
        run: |
          # ä» metadata.yaml æ–‡ä»¶ä¸­è¯»å–ç‰ˆæœ¬å·ï¼Œå¹¶ç§»é™¤å¯èƒ½å­˜åœ¨çš„ 'v' å‰ç¼€
          VERSION=$(grep "^version:" metadata.yaml | awk '{print $2}')
          # ç§»é™¤å¯èƒ½å­˜åœ¨çš„ 'v' å‰ç¼€ä»¥é¿å…é‡å¤
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=v$VERSION" >> $GITHUB_OUTPUT

      # 4. å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          if [ -f requirements.txt ] && [ -s requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "requirements.txt ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
          fi

      # 5. åˆ›å»ºæ’ä»¶ç›®å½•
      - name: åˆ›å»ºæ’ä»¶ç›®å½•
        run: |
          mkdir -p astrbot_plugin_treasure_bag

      # 6. å¤åˆ¶æ’ä»¶æ–‡ä»¶åˆ°æ„å»ºç›®å½•
      - name: å¤åˆ¶æ’ä»¶æ–‡ä»¶
        run: |
          # åˆ›å»ºæ’ä»¶ç›®å½•ç»“æ„
          mkdir -p astrbot_plugin_treasure_bag

          # å¤åˆ¶ä¸»ç¨‹åºæ–‡ä»¶
          cp main.py astrbot_plugin_treasure_bag/
          # å¤åˆ¶é…ç½®æ–‡ä»¶å’Œä¾èµ–æ–‡ä»¶
          cp metadata.yaml requirements.txt _conf_schema.json astrbot_plugin_treasure_bag/ || true
          # å¤åˆ¶æ‰€æœ‰ç›¸å…³æ¨¡å—
          cp __init__.py astrbot_plugin_treasure_bag/ || true
          # å¤åˆ¶å­ç›®å½•
          cp -r handlers astrbot_plugin_treasure_bag/ || true
          cp -r baidu astrbot_plugin_treasure_bag/ || true
          cp -r utils astrbot_plugin_treasure_bag/ || true
          cp -r config astrbot_plugin_treasure_bag/ || true
          # å¤åˆ¶ logo æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          cp logo.png astrbot_plugin_treasure_bag/ || true

      # 7. æ‰“åŒ…ä¸º zip æ–‡ä»¶
      - name: åˆ›å»º zip åŒ…
        run: |
          zip -r astrbot_plugin_treasure_bag.zip astrbot_plugin_treasure_bag/

      # 8. ç”Ÿæˆ Release Notes
      - name: ç”Ÿæˆ Release Notes
        id: release_notes
        run: |
          # ä»ä¸Šä¸€ä¸ªæ ‡ç­¾ç”Ÿæˆå‘å¸ƒè¯´æ˜
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          VERSION=${{ steps.get_version.outputs.version }}

          # å®šä¹‰ç”Ÿæˆæ›´æ–°æ—¥å¿—çš„å‡½æ•°
          generate_changelog_from_git() {
            local PREVIOUS_TAG=$1
            local VERSION=$2

            # åˆå§‹åŒ–åˆ†ç±»
            local FEAT=""
            local FIX=""
            local REFACTOR=""
            local DOCS=""
            local TEST=""
            local STYLE=""
            local CHORE=""
            local PERF=""
            local CI=""
            local BUILD=""
            local OTHER=""

            # éå†æ‰€æœ‰ commit
            while IFS= read -r commit; do
              # æå– commit ç±»å‹å’Œæ¶ˆæ¯
              type=$(echo "$commit" | sed -n 's/^\([a-z]*\):.*/\1/p')
              msg=$(echo "$commit" | sed 's/^[a-z]*: *//')

              # æŒ‰ç±»å‹åˆ†ç±»
              case "$type" in
                feat)    FEAT="${FEAT}- ${msg}\n" ;;
                fix)     FIX="${FIX}- ${msg}\n" ;;
                refactor) REFACTOR="${REFACTOR}- ${msg}\n" ;;
                docs)    DOCS="${DOCS}- ${msg}\n" ;;
                test)    TEST="${TEST}- ${msg}\n" ;;
                style)   STYLE="${STYLE}- ${msg}\n" ;;
                chore)   CHORE="${CHORE}- ${msg}\n" ;;
                perf)    PERF="${PERF}- ${msg}\n" ;;
                ci)      CI="${CI}- ${msg}\n" ;;
                build)   BUILD="${BUILD}- ${msg}\n" ;;
                *)       OTHER="${OTHER}- ${msg}\n" ;;
              esac
            done < <(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%s" --no-merges)

            # æ„å»ºæ›´æ–°æ—¥å¿—
            NOTES="## ğŸ“¦ Release v${VERSION}\n\n"

            # æ·»åŠ å„ä¸ªåˆ†ç±»
            if [ -n "$FEAT" ]; then
              NOTES="${NOTES}### âœ¨ æ–°åŠŸèƒ½\n\n${FEAT}\n"
            fi

            if [ -n "$FIX" ]; then
              NOTES="${NOTES}### ğŸ› ä¿®å¤\n\n${FIX}\n"
            fi

            if [ -n "$PERF" ]; then
              NOTES="${NOTES}### âš¡ æ€§èƒ½ä¼˜åŒ–\n\n${PERF}\n"
            fi

            if [ -n "$REFACTOR" ]; then
              NOTES="${NOTES}### â™»ï¸ é‡æ„\n\n${REFACTOR}\n"
            fi

            if [ -n "$DOCS" ]; then
              NOTES="${NOTES}### ğŸ“ æ–‡æ¡£\n\n${DOCS}\n"
            fi

            if [ -n "$TEST" ]; then
              NOTES="${NOTES}### âœ… æµ‹è¯•\n\n${TEST}\n"
            fi

            if [ -n "$STYLE" ]; then
              NOTES="${NOTES}### ğŸ’„ æ ·å¼\n\n${STYLE}\n"
            fi

            if [ -n "$CI" ]; then
              NOTES="${NOTES}### ğŸ‘· CI\n\n${CI}\n"
            fi

            if [ -n "$BUILD" ]; then
              NOTES="${NOTES}### ğŸ“¦ æ„å»º\n\n${BUILD}\n"
            fi

            if [ -n "$CHORE" ]; then
              NOTES="${NOTES}### ğŸ”§ æ‚é¡¹\n\n${CHORE}\n"
            fi

            if [ -n "$OTHER" ]; then
              NOTES="${NOTES}### å…¶ä»–\n\n${OTHER}\n"
            fi

            # å¦‚æœæ²¡æœ‰ä»»ä½•æäº¤
            if [ "$NOTES" = "## ğŸ“¦ Release v${VERSION}\n\n" ]; then
              NOTES="${NOTES}æ— æ›´æ–°å†…å®¹\n"
            fi

            echo -e "$NOTES"
          }

          if [ -z "$PREVIOUS_TAG" ]; then
            # é¦–æ¬¡ Release
            NOTES="## ğŸ‰ é¦–æ¬¡ Release v${VERSION}\n\nè¿™æ˜¯äº’åŠ¨æ¸¸æˆæ’ä»¶çš„é¦–æ¬¡æ­£å¼ Releaseã€‚\n\n### åŠŸèƒ½ç‰¹æ€§\n\n- åŒ…å«çŒœæ•°å­—ã€ç­¾åˆ°ã€æŠ½å¥–ã€å•†åº—ã€æˆå°±ç³»ç»Ÿç­‰å¤šç§åŠŸèƒ½\n- æ”¯æŒåº“å­˜å’Œä½¿ç”¨ç‰©å“\n- æä¾›ç”¨æˆ·ä¸ªäººèµ„æ–™ç®¡ç†\n\n### ä½¿ç”¨æ–¹æ³•\n\nè¯·å‚è€ƒé¡¹ç›® README.md äº†è§£è¯¦ç»†ä½¿ç”¨æ–¹æ³•ã€‚"
          else
            # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ CHANGELOG.md
            if [ -f "CHANGELOG.md" ]; then
              # ä» CHANGELOG.md æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°å†…å®¹
              CHANGELOG_CONTENT=$(awk -v version="\\[${VERSION}\\]" '$0 ~ version {found=1} found {print} found && /^## / && !($0 ~ version) {exit}' CHANGELOG.md | tail -n +2)

              if [ -n "$CHANGELOG_CONTENT" ]; then
                NOTES="## ğŸ“¦ Release v${VERSION}\n\n${CHANGELOG_CONTENT}"
              else
                # CHANGELOG ä¸­æ²¡æœ‰æ‰¾åˆ°å½“å‰ç‰ˆæœ¬ï¼Œä» git log ç”Ÿæˆ
                NOTES=$(generate_changelog_from_git "$PREVIOUS_TAG" "$VERSION")
              fi
            else
              # ä» git log ç”Ÿæˆæ›´æ–°æ—¥å¿—
              NOTES=$(generate_changelog_from_git "$PREVIOUS_TAG" "$VERSION")
            fi
          fi

          # æ·»åŠ  Release Notes
          RELEASE_FOOTER="\n\n---\n\n### ğŸ“¥ å®‰è£…æ–¹æ³•\n\n\`\`\`bash\n# ä¸‹è½½æ’ä»¶åŒ…åï¼Œå°†å…¶æ”¾å…¥ AstrBot çš„ plugins ç›®å½•\n# ç„¶åé‡å¯ AstrBot æœåŠ¡\n"

          NOTES="${NOTES}${RELEASE_FOOTER}"

          # ä¿å­˜åˆ°æ–‡ä»¶
          echo -e "$NOTES" > release_notes.md

          # è¾“å‡ºåˆ°ç¯å¢ƒå˜é‡
          {
            echo 'notes<<EOF'
            cat release_notes.md
            echo EOF
          } >> $GITHUB_OUTPUT

      # 9. ç”Ÿæˆè¯æ®åŒ…
      - name: ç”Ÿæˆè¯æ®åŒ…
        if: always()  # å³ä½¿æ„å»ºå¤±è´¥ä¹Ÿè¿è¡Œ
        uses: OrygnsCode/ci-evidence-pack@8222d7b3b015ce2f72222215bdf9966773036ab1 # main
        with:
          sign: 'true'

      # 10. åˆ›å»º GitHub Release
      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ steps.get_version.outputs.tag_name }}
          name: Release ${{ steps.get_version.outputs.version }}
          body: |
            ${{ steps.release_notes.outputs.notes }}

            ---

            ## ğŸ“¦ è¯æ®åŒ…è¯´æ˜

            æœ¬ Release åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š

            - **astrbot_plugin_treasure_bag-*.zip**: æ’ä»¶å®‰è£…åŒ…
            - **evidence-bundle.tar.gz**: CI è¯æ®åŒ…ï¼ˆåŒ…å«æºä»£ç ã€Git å…ƒæ•°æ®ã€ä¾èµ–é¡¹ã€SBOM ç­‰ï¼‰
            - **evidence-bundle.tar.gz.sig**: è¯æ®åŒ…çš„ Sigstore ç­¾å
            - **evidence-bundle.tar.gz.crt**: è¯æ®åŒ…çš„ç­¾åè¯ä¹¦

            è¯æ®åŒ…ç”¨äºåˆè§„æ€§å®¡è®¡å’Œæ„å»ºéªŒè¯ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éªŒè¯ï¼š

            ```bash
            ci-evidence-pack verify evidence-bundle.tar.gz
            ```
          draft: false
          prerelease: false
          files: |
            astrbot_plugin_treasure_bag.zip
            _evidence_dist/*.tar.gz
            _evidence_dist/*.sig
            _evidence_dist/*.crt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}