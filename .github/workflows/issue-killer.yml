name: 'ğŸš€ iFlow CLI Issue ç»ˆç»“è€…'

on:
  issue_comment:
    types:
      - 'created'
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'è¦å®ç°çš„ issue ç¼–å·'
        required: true
        type: 'number'

concurrency:
  group: '${{ github.workflow }}-${{ github.event.issue.number }}'
  cancel-in-progress: true

defaults:
  run:
    shell: 'bash'

permissions:
  contents: 'write'
  issues: 'write'
  pull-requests: 'write'

jobs:
  implement-issue:
    if: |-
      github.event.sender.type != 'Bot' && (
        github.event_name == 'workflow_dispatch' ||
        (
          github.event_name == 'issue_comment' &&
          contains(github.event.comment.body, '@iflow-issue-killer') &&
          contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)
        )
      )
    runs-on: 'ubuntu-latest'
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è·å– Issue è¯¦æƒ…
        id: get_issue
        uses: 'actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = process.env.INPUT_ISSUE_NUMBER || context.issue.number;
            core.setOutput('issue_number', issue_number);

            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issue_number)
            });

            core.setOutput('issue_title', issue.data.title);
            core.setOutput('issue_body', issue.data.body);

            // Parse implementation request from comment or use issue body
            let implementation_request = issue.data.body;
            if (context.eventName === 'issue_comment') {
              implementation_request = context.payload.comment.body.replace('@iflow-issue-killer', '').trim();
              if (implementation_request === '') {
                implementation_request = issue.data.body;
              }
            }

            core.setOutput('implementation_request', implementation_request);

      - name: 'è¿è¡Œ iFlow CLI å®ç°'
        uses: iflow-ai/iflow-cli-action@v2.0.0
        id: 'iflow_cli_implementation'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          ISSUE_TITLE: '${{ steps.get_issue.outputs.issue_title }}'
          ISSUE_BODY: '${{ steps.get_issue.outputs.issue_body }}'
          ISSUE_NUMBER: '${{ steps.get_issue.outputs.issue_number }}'
          REPOSITORY: '${{ github.repository }}'
        with:
          precmd: "git config --global --add safe.directory /github/workspace"
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: "1800"
          debug: "true"
          settings_json: |
            {
                "selectedAuthType": "iflow",
                "apiKey": "${{ secrets.IFLOW_API_KEY }}",
                "baseUrl": "https://apis.iflow.cn/v1",
                "modelName": "qwen3-coder-plus",
                "searchApiKey": "${{ secrets.IFLOW_API_KEY }}",
                "mcpServers": {
                  "github": {
                  "command": "github-mcp-server",
                  "args": [
                    "stdio"
                  ],
                  "includeTools": [
                    "create_pull_request",
                    "list_pull_requests",
                    "add_issue_comment"
                  ],
                    "env": {
                      "GITHUB_PERSONAL_ACCESS_TOKEN": "${{ secrets.GITHUB_TOKEN }}"
                    }
                  }
                }
            }
          prompt: |
            ## è§’è‰²

            ä½ æ˜¯ä¸€ä¸ªå®ç°åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®æä¾›çš„ GitHub issue å®ç°ä¸€ä¸ªåŠŸèƒ½ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

            1. **é¦–å…ˆ**ï¼šä½¿ç”¨ GitHub MCP å·¥å…·åœ¨ issue ä¸Šåˆ›å»ºå¼€å§‹è¯„è®º
            2. åˆ†æç¯å¢ƒå˜é‡ä¸­æä¾›çš„ issue æ ‡é¢˜å’Œæ­£æ–‡ï¼š"${ISSUE_TITLE}" å’Œ "${ISSUE_BODY}"ã€‚
            3. å¦‚æœè§¦å‘æ­¤æ“ä½œçš„è¯„è®ºåŒ…å«é¢å¤–çš„å®ç°è¯´æ˜ï¼Œä¹Ÿè¯·ä½¿ç”¨å®ƒä»¬ã€‚
            4. é€šè¿‡åˆ›å»ºæˆ–ä¿®æ”¹æ‰€éœ€æ–‡ä»¶æ¥å®ç°è¯·æ±‚çš„åŠŸèƒ½ã€‚
            5. ç¡®ä¿æ‰€æœ‰æ›´æ”¹æ ¹æ® issue è¦æ±‚éƒ½æ˜¯å®Œæ•´å’Œæ­£ç¡®çš„ã€‚
            6. é™¤äº†æ‰€éœ€çš„å¼€å§‹å’Œå®Œæˆè¯„è®ºå¤–ï¼Œä¸è¦æ·»åŠ è¯„è®ºæˆ–ä¿®æ”¹ issue å†…å®¹ã€‚
            7. ä»…ä¸“æ³¨äºå®ç°å½“å‰çš„ issueã€‚

            ## åˆ›å»ºå¼€å§‹è¯„è®º

            åœ¨å¼€å§‹å®ç°ä¹‹å‰ï¼Œä½¿ç”¨ GitHub MCP å·¥å…·åœ¨ issue ä¸Šåˆ›å»ºå¼€å§‹è¯„è®ºï¼š
            1. ä½¿ç”¨ add_issue_comment å‘ issue #${ISSUE_NUMBER} æ·»åŠ è¯„è®º
            2. å¼€å§‹è¯„è®ºåº”åŒ…æ‹¬ï¼š
               - ğŸš€ å®ç°ä»»åŠ¡å·²å¼€å§‹çš„é€šçŸ¥
               - ğŸ¤– æåŠ iFlow CLI Issue ç»ˆç»“è€…æ­£åœ¨å¤„ç†è¯¥ issue
               - ğŸ“‹ å½“å‰çŠ¶æ€ï¼šæ­£åœ¨åˆ†æå’Œå®ç°åŠŸèƒ½
               - ğŸ“ **æ‰§è¡Œè®¡åˆ’**ï¼šåŸºäº issue è¦æ±‚çš„è®¡åˆ’å®ç°æ­¥éª¤çš„ç®€è¦æ¦‚è¿°
               - â±ï¸ é¢„è®¡æ—¶é—´ï¼šé€šå¸¸éœ€è¦å‡ åˆ†é’Ÿåˆ°ååˆ†é’Ÿ
               - ğŸ” **æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—**ï¼š[GitHub Actions è¿è¡Œ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
               - ğŸ¤– è¯·æ³¨æ„è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨è¯„è®ºï¼Œä¼šæœ‰å®Œæˆé€šçŸ¥
            3. å¯¹äºæ‰§è¡Œè®¡åˆ’ï¼Œåˆ†æ issue è¦æ±‚å¹¶æä¾›æ¸…æ™°çš„ã€ç¼–å·çš„å®ç°æ­¥éª¤åˆ—è¡¨ï¼Œä¾‹å¦‚ï¼š
               - è¦åˆ›å»ºæˆ–ä¿®æ”¹çš„æ–‡ä»¶
               - è¦å®ç°çš„å…³é”®åŠŸèƒ½
               - è¦æ·»åŠ æˆ–æ›´æ–°çš„æµ‹è¯•
               - è¦æ›´æ”¹çš„ä¾èµ–é¡¹æˆ–é…ç½®

            ## æŒ‡å—

            - è¿›è¡Œæ‰€æœ‰å¿…è¦çš„ä»£ç æ›´æ”¹ä»¥å®ç°åŠŸèƒ½
            - ç¡®ä¿æ–°ä»£ç éµå¾ªç°æœ‰çš„é¡¹ç›®çº¦å®š
            - å¦‚é€‚ç”¨ï¼Œæ·»åŠ æˆ–ä¿®æ”¹æµ‹è¯•
            - å°†æ‰€æœ‰ shell å˜é‡å¼•ç”¨ä¸º "${VAR}"ï¼ˆå¸¦å¼•å·å’ŒèŠ±æ‹¬å·ï¼‰

            ## åˆ›å»º Pull Request

            å®ç°åŠŸèƒ½åï¼Œä½¿ç”¨ GitHub MCP å·¥å…·åˆ›å»º pull requestï¼š
            1. ä½¿ç”¨ create_pull_request åˆ›å»º Pull Requestã€‚
            2. PR åº”ä»å…·æœ‰æè¿°æ€§åç§°çš„æ–°åˆ†æ”¯åˆ›å»ºï¼ˆä¾‹å¦‚ï¼Œfeature/issue-${ISSUE_NUMBER}ã€fix/issue-${ISSUE_NUMBER} æˆ–åŸºäºåŠŸèƒ½çš„æè¿°æ€§åç§°ï¼‰
            3. PR æ ‡é¢˜åº”å…·æœ‰æè¿°æ€§å¹¶å¼•ç”¨ issue ç¼–å·
            4. PR æ­£æ–‡åº”è§£é‡Šå·²å®ç°çš„å†…å®¹å¹¶å¼•ç”¨ issue
            5. è®°ä½ä½ åˆ›å»ºçš„åˆ†æ”¯åç§°ï¼Œå¦‚æœ PR åˆ›å»ºå¤±è´¥ï¼Œå®Œæˆè¯„è®ºå°†éœ€è¦å®ƒ

            ## åˆ›å»ºå®Œæˆè¯„è®º

            æˆåŠŸå®ç°åŠŸèƒ½å¹¶åˆ›å»º PR åï¼Œä½¿ç”¨ GitHub MCP å·¥å…·å‘ issue æ·»åŠ å®Œæˆè¯„è®ºï¼š
            1. ä½¿ç”¨ add_issue_comment å‘ issue #${ISSUE_NUMBER} æ·»åŠ è¯„è®º
            2. è¯„è®ºåº”åŒ…æ‹¬ï¼š
               - âœ… ç¡®è®¤ issue å·²å®ç°
               - ğŸ‰ æ‰€å®Œæˆå†…å®¹çš„ç®€è¦æ‘˜è¦
               - ğŸ“‹ æ‰€åšå…³é”®æ›´æ”¹çš„åˆ—è¡¨
               - ğŸ”— åˆ°åˆ›å»ºçš„ Pull Request çš„é“¾æ¥ï¼ˆå¦‚æœæˆåŠŸï¼‰
               - ğŸ“ å¦‚æœ PR åˆ›å»ºå¤±è´¥ï¼Œä½¿ç”¨ä½ åˆ›å»ºçš„å®é™…åˆ†æ”¯åç§°æä¾›æ‰‹åŠ¨ PR åˆ›å»ºé“¾æ¥ï¼Œä¾‹å¦‚ï¼šhttps://github.com/${{ github.repository }}/compare/main...[YOUR_BRANCH_NAME]
               - ğŸ¤– è¯·æ³¨æ„è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨å®ç°
            3. ä½¿ç”¨å‹å¥½çš„è¯­æ°”å¹¶åŒ…å«é€‚å½“çš„è¡¨æƒ…ç¬¦å·ä»¥è·å¾—æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

      - name: 'å‘å¸ƒå®ç°å¤±è´¥è¯„è®º'
        if: |-
          ${{ failure() && steps.iflow_cli_implementation.outcome == 'failure' }}
        uses: 'actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd'
        with:
          github-token: '${{ secrets.GITHUB_TOKEN }}'
          script: |-
            github.rest.issues.createComment({
              owner: '${{ github.repository }}'.split('/')[0],
              repo: '${{ github.repository }}'.split('/')[1],
              issue_number: '${{ steps.get_issue.outputs.issue_number }}',
              body: 'iFlow CLI issue å®ç°å­˜åœ¨é—®é¢˜ã€‚è¯·æ£€æŸ¥ [action æ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) äº†è§£è¯¦æƒ…ã€‚'
            })