name: 构建和部署主页

on:
  workflow_dispatch:
  # 推送到 main 分支时也运行
  push:
    branches: [ main ]
    paths:
      - 'README.md'
      - 'README_zh.md'

# 设置 GITHUB_TOKEN 权限以允许部署到 GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# 仅允许一个并发部署，跳过正在运行的运行与最新排队的运行之间的队列。
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAGES: true
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 设置 Pages
        uses: actions/configure-pages@v4

      - name: 创建主页目录
        run: mkdir -p _site

      - name: 使用 iFlow CLI 生成主页
        uses: iflow-ai/iflow-cli-action@v2.0.0
        with:
          precmd: "ls -al"
          prompt: |
            读取当前仓库的 README.md 文件，将其转换为类似 GitLab Wiki 风格的文档网站并保存为 _site/index.html。

            要求：
            1. 使用 HTML5 + CSS3 构建 GitLab Wiki 风格文档站，采用 GitLab 的设计语言
            2. 页面结构（参考 GitLab Wiki）：
               - 顶部导航栏：Wiki、Code、Issues、Pull requests、Events、Packages、Insights 等标签页
               - 主内容区：三栏布局
                 * 左侧边栏：Wiki 页面列表（类似 GitLab 的页面树），支持滚动
                 * 中间内容：Wiki 文章内容，最大宽度 880px
                 * 右侧边栏：当前页面编辑信息、最后更新时间、操作按钮
               - 底部：项目信息
            
            3. 视觉设计（GitLab 风格）：
               - 主色调：GitLab 蓝色（#292961）和橙色（#E24329）
               - 背景色：白色（#ffffff）和浅灰色（#fbfbfb）
               - 边框色：#e5e5e5
               - 字体：系统默认字体（-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif）
               - 字重：常规 400，加粗 600，标题 700
               - 圆角：4px-8px
               - 阴影：轻微阴影用于卡片和按钮

            4. 排版优化（GitLab 风格）：
               - H1：2rem（32px），颜色 #0a1228，字重 700
               - H2：1.5rem（24px），颜色 #0a1228，字重 600
               - H3：1.25rem（20px），颜色 #0a1228，字重 600
               - 正文：1rem（16px），行高 1.5，颜色 #303030
               - 代码：等宽字体，0.875rem（14px），行高 1.6
               - 段落间距：1.5em
               - 列表项：使用 GitLab 风格的项目符号
               - 引用块：左边框 4px，背景 #f8f8f8，内边距 12px

            5. 顶部导航栏设计：
               - 背景：#292961（GitLab 深蓝）
               - 高度：56px
               - 项目路径：白色文字，用斜杠（/）分隔，悬停显示下划线
               - 右侧：搜索框（浅色输入框）+ 登录按钮（WeChat Login / Login）
               - 响应式：移动端隐藏部分元素，使用汉堡菜单

            6. 二级导航设计：
               - 背景：白色或浅灰色（#fbfbfb）
               - 边框底部：1px solid #e5e5e5
               - 标签项：内边距 12px 16px，颜色 #303030
               - 激活状态：底部 2px 蓝色边框或背景高亮
               - 悬停效果：背景 #f0f0f0

            7. 左侧边栏（页面列表）：
               - 背景：#f8f8f8
               - 宽度：280px
               - 页面列表：每个页面项显示标题和图标
               - 当前页面：背景 #e0f0ff 或蓝色高亮
               - 支持搜索过滤页面列表
               - 滚动时固定


            8. 主内容区设计：
                - 最大宽度：880px
                - 内边距：32px
                - 代码块：使用 GitLab 的代码高亮主题
                - 表格：GitLab 风格表格（斑马纹，边框）
                - 图片：响应式，最大宽度 100%
                - 链接：GitLab 蓝色（#1068bf），悬停 underline

            9. 代码展示优化：
                - 使用 highlight.js，采用 GitLab 代码主题
                - 支持多种语言高亮
                - 代码块背景：#fcfcfc
                - 边框：1px solid #e5e5e5
                - 圆角：4px
                - 行号：浅色显示
                - 复制按钮：右上角

            10. 响应式设计：
                - 桌面（≥1280px）：完整三栏布局
                - 平板（992px-1279px）：双栏布局，右侧边栏移到底部
                - 移动（<992px）：单栏布局，侧边栏通过菜单打开
                - 移动端顶部导航栏简化

            11. 交互功能：
                - 页面列表搜索过滤
                - 目录点击跳转
                - 编辑按钮（模拟）
                - 页面切换动画
                - 平滑滚动
                - 返回顶部按钮

            13. 技术实现：
                - 从 CDN 引入：highlight.js（GitLab 主题）
                - 使用 Flexbox 和 Grid 布局
                - CSS 变量定义 GitLab 主题颜色
                - 原生 JavaScript 实现交互
                - SVG 图标（GitLab 风格）
                - 使用 CSS Grid 实现三栏布局

            请创建完整的 HTML 文件，使用内联 CSS 和 JavaScript，确保文件自包含且可直接运行。
            项目地址：https://github.com/iflow-ai/iflow-cli-action
          api_key: ${{ secrets.IFLOW_API_KEY }}
          # settings_json: ${{ secrets.IFLOW_SETTINGS_JSON }}
          model: "qwen3-coder-plus"
          timeout: "1800"
          debug: "true"

      - name: 验证 Wiki 网站已生成
        run: |
          if [ -f "_site/index.html" ]; then
            echo "Wiki 网站生成成功！"
            echo "正在检查网站内容..."
            if grep -q "<!DOCTYPE html>" "_site/index.html"; then
              echo "✓ 检测到有效的 HTML5 文档"
            else
              echo "⚠ 警告：生成的文件可能不是有效的 HTML 文档"
            fi
            ls -la _site/
          else
            echo "错误：Wiki 网站未由 iFlow 生成"
            exit 1
          fi

      - name: 上传构建产物
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: 部署到 GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
