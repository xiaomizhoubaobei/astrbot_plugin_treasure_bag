name: 'ğŸš€ iFlow CLI PR å®¡æŸ¥ç»ˆç»“è€…'

on:
  issue_comment:
    types:
      - 'created'

concurrency:
  group: '${{ github.workflow }}-${{ github.event.issue.number }}'
  cancel-in-progress: true

defaults:
  run:
    shell: 'bash'

permissions:
  contents: 'write'
  issues: 'write'
  pull-requests: 'write'

jobs:
  modify-code:
    if: |-
      github.event.sender.type != 'Bot' &&
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      (
        contains(github.event.comment.body, '@iflow-cli /review-killer') ||
        contains(github.event.comment.body, '@iFlow-CLI /review-killer') ||
        contains(github.event.comment.body, '@IFLOW-CLI /review-killer') ||
        contains(github.event.comment.body, '@IFlow-CLI /review-killer')
      ) &&
      contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)
    runs-on: 'ubuntu-latest'
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: æ£€å‡º PR åˆ†æ”¯
        uses: xt0rted/pull-request-comment-branch@v3.0.0
        id: checkout_pr

      - name: ä»è¯„è®ºä¸­æå–è¯´æ˜
        id: extract
        run: |
          COMMENT="${{ github.event.comment.body }}"
          # Extract everything after "@iflow-cli /review-killer " (case insensitive)
          # First check if the pattern exists, then extract
          if echo "$COMMENT" | grep -qiE '@iflow-cli[[:space:]]+/review-killer'; then
            INSTRUCTIONS=$(echo "$COMMENT" | sed -E 's/.*@[iI][fF][lL][oO][wW]-[cC][lL][iI][[:space:]]+\/[rR][eE][vV][iI][eE][wW]-[kK][iI][lL][lL][eE][rR][[:space:]]*(.*)/\1/' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          else
            INSTRUCTIONS=""
          fi
          echo "instructions=$INSTRUCTIONS" >> $GITHUB_OUTPUT

      - name: 'è¿è¡Œ iFlow CLI å®ç°'
        uses: iflow-ai/iflow-cli-action@v2.0.0
        id: 'iflow_cli_implementation'
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: "1800"
          debug: "true"
          settings_json: |
            {
                "selectedAuthType": "iflow",
                "apiKey": "${{ secrets.IFLOW_API_KEY }}",
                "baseUrl": "https://apis.iflow.cn/v1",
                "modelName": "qwen3-coder-plus",
                "searchApiKey": "${{ secrets.IFLOW_API_KEY }}",
                "mcpServers": {
                  "github": {
                  "command": "github-mcp-server",
                  "args": [
                    "stdio"
                  ],
                  "includeTools": [
                    "add_issue_comment"
                  ],
                    "env": {
                      "GITHUB_PERSONAL_ACCESS_TOKEN": "${{ secrets.GITHUB_TOKEN }}"
                    }
                  }
                }
            }
          prompt: |
            ## è§’è‰²

            ä½ æ˜¯ä¸€ä¸ª PR å®¡æŸ¥åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®
            å®¡æŸ¥è¯„è®ºä¿®æ”¹ä»£ç ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

            1. åˆ†æç¯å¢ƒå˜é‡ä¸­æä¾›çš„ PR å®¡æŸ¥è¯„è®ºã€‚
            2. ä»è¯„è®ºä¸­æå–ä¿®æ”¹è¯´æ˜ï¼š"${{ steps.extract.outputs.instructions }}"
            3. é€šè¿‡åˆ›å»ºæˆ–ä¿®æ”¹æ‰€éœ€æ–‡ä»¶æ¥å®ç°è¯·æ±‚çš„æ›´æ”¹ã€‚
            4. ç¡®ä¿æ‰€æœ‰æ›´æ”¹æ ¹æ®å®¡æŸ¥è¦æ±‚éƒ½æ˜¯å®Œæ•´å’Œæ­£ç¡®çš„ã€‚
            5. ä»…ä¸“æ³¨äºå®ç°å½“å‰çš„å®¡æŸ¥è¯„è®ºã€‚

            ## æŒ‡å—

            - è¿›è¡Œæ‰€æœ‰å¿…è¦çš„ä»£ç æ›´æ”¹ä»¥è§£å†³å®¡æŸ¥è¯„è®º
            - ç¡®ä¿æ–°ä»£ç éµå¾ªç°æœ‰çš„é¡¹ç›®çº¦å®š
            - å¦‚é€‚ç”¨ï¼Œæ·»åŠ æˆ–ä¿®æ”¹æµ‹è¯•
            - å°†æ‰€æœ‰ shell å˜é‡å¼•ç”¨ä¸º "${VAR}"ï¼ˆå¸¦å¼•å·å’ŒèŠ±æ‹¬å·ï¼‰

            ## æäº¤æ›´æ”¹

            å®ç°æ›´æ”¹åï¼š
            1. æš‚å­˜æ‰€æœ‰ä¿®æ”¹çš„æ–‡ä»¶
            2. ä½¿ç”¨æè¿°æ€§æ¶ˆæ¯æäº¤æ›´æ”¹
            3. å°†æ›´æ”¹æ¨é€åˆ° ${{ steps.checkout_pr.outputs.head_ref }} åˆ†æ”¯

            **åˆ‡å‹¿ç›´æ¥æäº¤åˆ° `main` åˆ†æ”¯ã€‚**
            **åˆ‡å‹¿å¼ºåˆ¶æ¨é€**